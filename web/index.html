<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FGSM 对抗攻击演示</title>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <header>
      <h1>FGSM 对抗攻击演示</h1>
    </header>
    <main>
      <section class="panel">
        <div class="field">
          <label>上传图片（PNG/JPG）</label>
          <input id="imageInput" type="file" accept="image/*" />
        </div>
        <div class="field">
          <label>上传模型（可选，.pth）</label>
          <input id="modelInput" type="file" accept=".pth" />
        </div>
        <div class="field">
          <label>攻击类型</label>
          <select id="attackType">
            <option value="fgsm" selected>FGSM（单步）</option>
            <option value="ifgsm">I-FGSM（迭代）</option>
          </select>
        </div>
        <div class="field">
          <label>攻击目标模式</label>
          <div class="epsilon-row">
            <label><input type="radio" name="targetMode" value="untargeted" checked> 无目标（Untargeted）</label>
            <label><input type="radio" name="targetMode" value="targeted"> 靶向（Targeted）</label>
          </div>
        </div>
        <div class="field" id="targetClassRow" style="display: none;">
          <label>目标类别（Target Class）</label>
          <select id="targetClassInput">
            <option value="0">T-shirt/top (0)</option>
            <option value="1">Trouser (1)</option>
            <option value="2">Pullover (2)</option>
            <option value="3">Dress (3)</option>
            <option value="4">Coat (4)</option>
            <option value="5">Sandal (5)</option>
            <option value="6">Shirt (6)</option>
            <option value="7">Sneaker (7)</option>
            <option value="8">Bag (8)</option>
            <option value="9">Ankle boot (9)</option>
          </select>
        </div>
        <div class="field">
          <label>epsilon</label>
          <div class="epsilon-row">
            <input id="epsilonRange" type="range" min="0" max="0.3" step="0.01" value="0.15" />
            <input id="epsilonNumber" type="number" min="0" max="0.3" step="0.01" value="0.15" />
          </div>
        </div>
        <div class="field">
          <label>迭代参数（iters / alpha，可选）</label>
          <div class="epsilon-row">
            <input id="itersNumber" type="number" min="1" max="100" step="1" value="10" />
            <input id="alphaNumber" type="number" min="0.0001" max="0.5" step="0.0001" placeholder="默认 epsilon/iters" />
          </div>
        </div>
        <div class="field">
          <label>自动攻击参数（步长 / 最大扰动）</label>
          <div class="epsilon-row">
            <input id="stepNumber" type="number" min="0.001" max="0.2" step="0.001" value="0.01" />
            <input id="maxEpsNumber" type="number" min="0" max="1" step="0.01" value="0.3" />
          </div>
        </div>
        <div class="actions">
          <button id="attackBtn">执行攻击</button>
          <button id="downloadBtn" class="secondary">下载对抗样本</button>
          <button id="autoBtn" class="secondary">自动攻击</button>
          <button id="compareBtn" class="secondary">对比 FGSM / I-FGSM</button>
          <button id="compareModesBtn" class="secondary">对比 无目标 / 靶向</button>
        </div>
      </section>

      <section class="result">
        <div class="cards">
          <div class="card">
            <h3>原始图片</h3>
            <img id="origImg" alt="原始图片预览" />
          </div>
          <div class="card">
            <h3 id="advTitle">对抗图片</h3>
            <img id="advImg" alt="对抗图片预览" />
          </div>
          <div class="card" id="advIfgsmCard" style="display: none;">
            <h3>I-FGSM 对抗图片</h3>
            <img id="advIfgsmImg" alt="I-FGSM 对抗图片预览" />
          </div>
          <div class="card" id="advTargetedCard" style="display: none;">
            <h3>靶向对抗图片</h3>
            <img id="advTargetedImg" alt="靶向对抗图片预览" />
          </div>
          <div class="card">
            <h3>掩膜 (Mask)</h3>
            <img id="maskImg" alt="掩膜预览" style="image-rendering: pixelated;" />
          </div>
        </div>
        <div class="summary">
          <div><strong>攻击结果：</strong> <span id="successText">—</span></div>
          <div><strong>最小扰动值 ε：</strong> <span id="epsilonText">—</span></div>
          <div><strong>预测前：</strong> <span id="predBefore">—</span></div>
          <div><strong>预测后：</strong> <span id="predAfter">—</span></div>
          <div id="predAfterIfgsmRow" style="display:none;"><strong>I-FGSM 预测后：</strong> <span id="predAfterIfgsm">—</span></div>
          <div id="predAfterTargetedRow" style="display:none;"><strong>靶向预测后：</strong> <span id="predAfterTargeted">—</span></div>
        </div>
      </section>

      <section class="result">
        <h3>更多对比</h3>
        <div id="compareControl" class="field" style="display: none;">
          <label>选择显示的对抗样本详情：</label>
          <div class="epsilon-row">
            <label><input type="radio" name="compareMode" value="mode1" checked> <span id="mode1Label">FGSM</span></label>
            <label><input type="radio" name="compareMode" value="mode2"> <span id="mode2Label">I-FGSM</span></label>
          </div>
        </div>
        <div class="cards">
          <div class="card">
            <h3>签名差值（Raw Diff）</h3>
            <canvas id="diffRawCanvas" width="112" height="112"></canvas>
          </div>
          <div class="card">
            <h3>绝对差值（Abs Diff）</h3>
            <canvas id="diffAbsCanvas" width="112" height="112"></canvas>
          </div>
          <div class="card">
            <h3>扰动热力图（Heatmap）</h3>
            <canvas id="heatmapCanvas" width="112" height="112"></canvas>
          </div>
        </div>
        <div class="cards">
          <div class="card">
            <h3>叠加对比（透明度可调）</h3>
            <div class="overlay-stack">
              <img id="overlayOrig" alt="原图" />
              <img id="overlayAdv" alt="对抗图" />
            </div>
            <div class="overlay-control">
              <label for="overlayRange">对抗透明度</label>
              <input id="overlayRange" type="range" min="0" max="1" step="0.01" value="1" />
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <small>后端：FastAPI (`/attack`, `/attack/adv-png`, `/attack/auto`)</small>
    </footer>

    <script src="./app.js"></script>
  </body>
  </html>
